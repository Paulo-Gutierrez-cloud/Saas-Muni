services:
  db:
    image: postgres:15
    container_name: licitaciones_db
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-licitaciones_ti}
    ports:
      - "5432:5432"
    volumes:
      - ./db/init/:/docker-entrypoint-initdb.d/
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    container_name: licitaciones_redis
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  sync-service:
    build:
      context: ./services/sync-service
    container_name: licitaciones_sync
    restart: always
    depends_on:
      - db
      - redis
    env_file:
      - .env

  api-gateway:
    build:
      context: ./services/api-gateway
    container_name: licitaciones_api
    restart: always
    ports:
      - "8000:8000"
    volumes:
      - ./services/api-gateway:/app
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    depends_on:
      - db
      - redis
    env_file:
      - .env

  analysis-agent:
    build:
      context: ./services/analysis-agent
    container_name: licitaciones_analysis
    restart: always
    depends_on:
      - db
      - redis
    env_file:
      - .env

  frontend:
    build:
      context: ./services/frontend
    container_name: licitaciones_frontend
    restart: always
    ports:
      - "3000:3000"
    volumes:
      - ./services/frontend:/app
      - /app/node_modules
      - /app/.next
    command: npm run dev
    depends_on:
      - api-gateway
    environment:
      - WATCHPACK_POLLING=true
      - CHOKIDAR_USEPOLLING=true
    env_file:
      - .env

  notifier:
    build:
      context: ./services/notifier-service
    container_name: licitaciones_notifier
    restart: always
    depends_on:
      - redis
    env_file:
      - .env

  openclaw:
    build:
      context: ./openclaw_analysis
      args:
        OPENCLAW_DOCKER_APT_PACKAGES: python3 python3-pip python3-psycopg2 libpq-dev python3-requests
    container_name: licitaciones_openclaw
    restart: unless-stopped
    ports:
      - "18789:18789"
    volumes:
      - ./openclaw_workspace:/home/node/.openclaw/workspace
      - ./openclaw_workspace/config:/home/node/.openclaw/config
    environment:
      - NODE_ENV=production
      - OPENCLAW_NO_AUTH=true 
      - OPENCLAW_GATEWAY_TOKEN=testtoken123
      - OPENCLAW_GATEWAY_HTTP_ENDPOINTS_CHAT_COMPLETIONS_ENABLED=true
      - DATABASE_URL=postgresql://postgres:postgres@db:5432/licitaciones_ti
      - OPENCLAW_CONFIG_PATH=/home/node/.openclaw/config/openclaw.json
      - OPENAI_BASE_URL=http://ollama:11434/v1
      - OPENAI_API_KEY=ollama
      - DEFAULT_MODEL=llama3
      - redis
      - ollama

  ollama:
    image: ollama/ollama:latest
    container_name: licitaciones_ollama
    restart: always
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama

  mcp-postgres:
    image: crystaldba/postgres-mcp:latest
    container_name: licitaciones_mcp_postgres
    restart: always
    environment:
      - POSTGRES_URL=postgresql://postgres:postgres@db:5432/licitaciones_ti
    command: --transport=sse --sse-port=8080 postgresql://postgres:postgres@db:5432/licitaciones_ti
    depends_on:
      - db

  # [MCP] Frontend Agent (Puppeteer)
  # Capacidad: Navegar, Renderizar, Testing UI
  licitaciones_mcp_browser:
    image: mcp/puppeteer:latest
    container_name: licitaciones_mcp_browser
    restart: always
    cap_add:
      - SYS_ADMIN
    command: --transport=sse --port=8081
    ports:
      - "8081:8081"
    
  # [MCP] Backend/Security Ops (Docker)
  # DISABLED due to crash loop - awaiting fix
  # licitaciones_mcp_docker:
  #   image: mcp/docker:latest
  #   container_name: licitaciones_mcp_docker
  #   restart: always
  #   user: "0:0"
  #   volumes:
  #     - /var/run/docker.sock:/var/run/docker.sock
  #   command: --transport=sse --port=8082
  #   ports:
  #     - "8082:8082"

volumes:
  postgres_data:
  redis_data:
  ollama_data:
